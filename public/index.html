<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>提案書自動生成システム</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState } = React;

    const ProposalGenerator = () => {
      const [step, setStep] = useState(1);
      const [loading, setLoading] = useState(false);
      const [extractedData, setExtractedData] = useState(null);
      const [generatedHTML, setGeneratedHTML] = useState('');
      
      const [inputData, setInputData] = useState({
        transcript: '',
        mockFiles: [],
        mockCodeText: ''
      });

      const [formData, setFormData] = useState({
        companyName: '株式会社ままよろ',
        contactPerson: '平野',
        email: 't.hirano@mamayoro.com',
        phone: '050-3662-5788',
        proposalTitle: '',
        proposalSubtitle: '',
        issues: [],
        solutions: [],
        systemArchitecture: '',
        techStack: [],
        effects: [],
        benefits: [],
        timeline: [],
        initialCost: '',
        monthlyCost: '',
        additionalCosts: [],
        summaryPoints: []
      });

      const handleFileUpload = (e) => {
        const files = Array.from(e.target.files);
        
        files.forEach(file => {
          const reader = new FileReader();
          reader.onload = (event) => {
            const fileData = {
              name: file.name,
              content: event.target.result,
              id: Date.now() + Math.random()
            };
            
            setInputData(prev => ({
              ...prev,
              mockFiles: [...prev.mockFiles, fileData]
            }));
          };
          reader.readAsText(file);
        });
        
        e.target.value = '';
      };

      const removeFile = (fileId) => {
        setInputData(prev => ({
          ...prev,
          mockFiles: prev.mockFiles.filter(f => f.id !== fileId)
        }));
      };

      const analyzeInput = async () => {
        setLoading(true);
        try {
          const mockCodeContent = inputData.mockFiles.map(file => 
            '# ' + file.name + '\n```javascript\n' + file.content + '\n```\n'
          ).join('\n\n');
          
          const additionalMockText = inputData.mockCodeText ? 
            '\n\n# 追加説明・コード\n' + inputData.mockCodeText : '';
          
          const fullMockContent = mockCodeContent + additionalMockText;
          
          const response = await fetch("/api/analyze", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              transcript: inputData.transcript,
              mockCode: fullMockContent
            })
          });

          if (!response.ok) {
            throw new Error('API request failed: ' + response.status);
          }

          const data = await response.json();
          
          setExtractedData(data);
          setFormData(prev => ({
            ...prev,
            proposalTitle: data.proposalTitle || '',
            proposalSubtitle: data.proposalSubtitle || '',
            issues: data.issues || [],
            solutions: data.solutions || [],
            systemArchitecture: data.systemArchitecture || '',
            techStack: data.techStack || [],
            effects: data.effects || [],
            benefits: data.benefits || [],
            timeline: data.timeline || [],
            initialCost: data.initialCost || '',
            monthlyCost: data.monthlyCost || '',
            additionalCosts: data.additionalCosts || [],
            summaryPoints: data.summaryPoints || []
          }));
          
          setStep(2);
        } catch (error) {
          console.error('AI解析エラー:', error);
          alert('AI解析中にエラーが発生しました。\n\nエラー詳細: ' + error.message);
        } finally {
          setLoading(false);
        }
      };

      const generateHTML = async () => {
        setLoading(true);
        try {
          const response = await fetch("/api/generate", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify(formData)
          });

          if (!response.ok) {
            throw new Error('API request failed: ' + response.status);
          }

          const data = await response.json();
          
          setGeneratedHTML(data.html);
          setStep(3);
        } catch (error) {
          console.error('HTML生成エラー:', error);
          alert('HTML生成中にエラーが発生しました。\n\nエラー詳細: ' + error.message);
        } finally {
          setLoading(false);
        }
      };

      const downloadHTML = () => {
        const blob = new Blob([generatedHTML], { type: 'text/html' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        const today = new Date().toISOString().split('T')[0].replace(/-/g, '');
        a.href = url;
        a.download = 'proposal_' + today + '.html';
        a.click();
        URL.revokeObjectURL(url);
      };

      return (
        <div className="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-500 to-pink-500 p-8">
          <div className="max-w-6xl mx-auto">
            <div className="bg-white rounded-lg shadow-2xl p-8 mb-8">
              <h1 className="text-4xl font-bold text-gray-800 mb-2">提案書自動生成システム</h1>
              <p className="text-gray-600">議事録とモックから、プロフェッショナルな提案書を自動生成</p>
              
              <div className="flex items-center justify-center mt-8 space-x-4">
                <div className={'flex items-center ' + (step >= 1 ? 'text-indigo-600' : 'text-gray-400')}>
                  <div className={'w-10 h-10 rounded-full flex items-center justify-center ' + (step >= 1 ? 'bg-indigo-600 text-white' : 'bg-gray-300')}>
                    1
                  </div>
                  <span className="ml-2 font-semibold">入力</span>
                </div>
                <div className="w-16 h-1 bg-gray-300"></div>
                <div className={'flex items-center ' + (step >= 2 ? 'text-indigo-600' : 'text-gray-400')}>
                  <div className={'w-10 h-10 rounded-full flex items-center justify-center ' + (step >= 2 ? 'bg-indigo-600 text-white' : 'bg-gray-300')}>
                    2
                  </div>
                  <span className="ml-2 font-semibold">確認</span>
                </div>
                <div className="w-16 h-1 bg-gray-300"></div>
                <div className={'flex items-center ' + (step >= 3 ? 'text-indigo-600' : 'text-gray-400')}>
                  <div className={'w-10 h-10 rounded-full flex items-center justify-center ' + (step >= 3 ? 'bg-indigo-600 text-white' : 'bg-gray-300')}>
                    3
                  </div>
                  <span className="ml-2 font-semibold">完成</span>
                </div>
              </div>
            </div>

            {step === 1 && (
              <div className="bg-white rounded-lg shadow-2xl p-8">
                <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                  📤 STEP 1: 情報を入力
                </h2>

                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-bold text-gray-700 mb-2">
                      📝 議事録・文字起こし
                    </label>
                    <textarea
                      className="w-full h-64 p-4 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none"
                      placeholder="ヒアリングの議事録や文字起こしを貼り付けてください..."
                      value={inputData.transcript}
                      onChange={(e) => setInputData({ ...inputData, transcript: e.target.value })}
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-bold text-gray-700 mb-2">
                      💻 モックコード（複数ファイル対応）
                    </label>
                    
                    <div className="mb-4">
                      <label className="inline-flex items-center px-4 py-3 bg-indigo-100 text-indigo-700 rounded-lg cursor-pointer hover:bg-indigo-200 transition">
                        <span className="mr-2">📤</span>
                        <span className="font-semibold">📁 JSファイルを追加</span>
                        <input
                          type="file"
                          accept=".js,.jsx,.ts,.tsx,.json,.txt"
                          multiple
                          onChange={handleFileUpload}
                          className="hidden"
                        />
                      </label>
                      <p className="text-xs text-gray-500 mt-2">
                        kintoneカスタマイズJS、React、その他のコードファイルを複数選択可能
                      </p>
                    </div>

                    {inputData.mockFiles.length > 0 && (
                      <div className="mb-4 space-y-2">
                        {inputData.mockFiles.map(file => (
                          <div key={file.id} className="flex items-center justify-between bg-gray-50 p-3 rounded-lg border border-gray-200">
                            <div className="flex items-center space-x-3">
                              <span className="text-indigo-600">📄</span>
                              <div>
                                <div className="font-semibold text-sm">{file.name}</div>
                                <div className="text-xs text-gray-500">
                                  {(file.content.length / 1024).toFixed(1)} KB
                                </div>
                              </div>
                            </div>
                            <button
                              onClick={() => removeFile(file.id)}
                              className="text-red-500 hover:text-red-700 font-bold"
                            >
                              ✕
                            </button>
                          </div>
                        ))}
                      </div>
                    )}

                    <textarea
                      className="w-full h-48 p-4 border-2 border-gray-300 rounded-lg focus:border-indigo-500 focus:outline-none font-mono text-sm"
                      placeholder="または、コードや解説を直接入力することもできます..."
                      value={inputData.mockCodeText}
                      onChange={(e) => setInputData({ ...inputData, mockCodeText: e.target.value })}
                    />
                  </div>

                  <button
                    onClick={analyzeInput}
                    disabled={loading || !inputData.transcript || (inputData.mockFiles.length === 0 && !inputData.mockCodeText)}
                    className="w-full bg-indigo-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-indigo-700 disabled:bg-gray-400 disabled:cursor-not-allowed flex items-center justify-center"
                  >
                    {loading ? (
                      <>
                        <span className="animate-spin mr-2">⏳</span>
                        AI解析中...
                      </>
                    ) : (
                      <>
                        <span className="mr-2">🪄</span>
                        🤖 AI解析開始
                      </>
                    )}
                  </button>
                </div>
              </div>
            )}

            {step === 2 && (
              <div className="bg-white rounded-lg shadow-2xl p-8">
                <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                  <span className="mr-2 text-green-500">✓</span>
                  STEP 2: 抽出内容を確認・編集
                </h2>

                <div className="space-y-6 max-h-[600px] overflow-y-auto pr-4">
                  <div className="border-b pb-4">
                    <h3 className="font-bold text-lg mb-3">基本情報</h3>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-semibold mb-1">会社名</label>
                        <input
                          type="text"
                          className="w-full p-2 border rounded"
                          value={formData.companyName}
                          onChange={(e) => setFormData({ ...formData, companyName: e.target.value })}
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold mb-1">担当者</label>
                        <input
                          type="text"
                          className="w-full p-2 border rounded"
                          value={formData.contactPerson}
                          onChange={(e) => setFormData({ ...formData, contactPerson: e.target.value })}
                        />
                      </div>
                    </div>
                  </div>

                  <div className="border-b pb-4">
                    <h3 className="font-bold text-lg mb-3">提案タイトル</h3>
                    <input
                      type="text"
                      className="w-full p-2 border rounded mb-2"
                      value={formData.proposalTitle}
                      onChange={(e) => setFormData({ ...formData, proposalTitle: e.target.value })}
                    />
                    <input
                      type="text"
                      className="w-full p-2 border rounded"
                      placeholder="サブタイトル"
                      value={formData.proposalSubtitle}
                      onChange={(e) => setFormData({ ...formData, proposalSubtitle: e.target.value })}
                    />
                  </div>

                  <div className="border-b pb-4">
                    <h3 className="font-bold text-lg mb-3">課題 ({formData.issues.length}個)</h3>
                    {formData.issues.map((issue, idx) => (
                      <div key={idx} className="bg-gray-50 p-3 rounded mb-2">
                        <div className="font-semibold">{issue.icon} {issue.title}</div>
                        <div className="text-sm text-gray-600 mt-1">{issue.description}</div>
                      </div>
                    ))}
                  </div>

                  <div className="border-b pb-4">
                    <h3 className="font-bold text-lg mb-3">ソリューション ({formData.solutions.length}個)</h3>
                    {formData.solutions.map((solution, idx) => (
                      <div key={idx} className="bg-gray-50 p-3 rounded mb-2">
                        <div className="font-semibold">{solution.icon} {solution.title}</div>
                        <div className="text-sm text-gray-600 mt-1">{solution.description}</div>
                      </div>
                    ))}
                  </div>

                  <div className="border-b pb-4">
                    <h3 className="font-bold text-lg mb-3">費用</h3>
                    <div className="grid grid-cols-2 gap-4">
                      <div>
                        <label className="block text-sm font-semibold mb-1">初期費用</label>
                        <input
                          type="text"
                          className="w-full p-2 border rounded"
                          value={formData.initialCost}
                          onChange={(e) => setFormData({ ...formData, initialCost: e.target.value })}
                        />
                      </div>
                      <div>
                        <label className="block text-sm font-semibold mb-1">月額費用</label>
                        <input
                          type="text"
                          className="w-full p-2 border rounded"
                          value={formData.monthlyCost}
                          onChange={(e) => setFormData({ ...formData, monthlyCost: e.target.value })}
                        />
                      </div>
                    </div>
                  </div>
                </div>

                <div className="flex space-x-4 mt-6">
                  <button
                    onClick={() => setStep(1)}
                    className="flex-1 bg-gray-300 text-gray-700 py-3 rounded-lg font-bold hover:bg-gray-400"
                  >
                    ← 戻る
                  </button>
                  <button
                    onClick={generateHTML}
                    disabled={loading}
                    className="flex-1 bg-indigo-600 text-white py-3 rounded-lg font-bold hover:bg-indigo-700 disabled:bg-gray-400 flex items-center justify-center"
                  >
                    {loading ? (
                      <>
                        <span className="animate-spin mr-2">⏳</span>
                        生成中...
                      </>
                    ) : (
                      <>
                        <span className="mr-2">📄</span>
                        提案書生成
                      </>
                    )}
                  </button>
                </div>
              </div>
            )}

            {step === 3 && (
              <div className="bg-white rounded-lg shadow-2xl p-8">
                <h2 className="text-2xl font-bold text-gray-800 mb-6 flex items-center">
                  <span className="mr-2 text-green-500">✓</span>
                  STEP 3: 完成！
                </h2>

                <div className="bg-green-50 border-2 border-green-500 rounded-lg p-6 mb-6">
                  <p className="text-green-800 font-semibold text-lg mb-2">✨ 提案書HTMLが生成されました！</p>
                  <p className="text-green-700">プレビューを確認して、ダウンロードしてください。</p>
                </div>

                <div className="flex space-x-4 mb-6">
                  <button
                    onClick={downloadHTML}
                    className="flex-1 bg-indigo-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-indigo-700 flex items-center justify-center"
                  >
                    <span className="mr-2">💾</span>
                    HTMLダウンロード
                  </button>
                  <button
                    onClick={() => setStep(1)}
                    className="flex-1 bg-gray-300 text-gray-700 py-4 rounded-lg font-bold text-lg hover:bg-gray-400"
                  >
                    🔄 新規作成
                  </button>
                </div>

                <div className="border-4 border-gray-300 rounded-lg overflow-hidden">
                  <div className="bg-gray-200 p-3 flex items-center">
                    <span className="mr-2">👁️</span>
                    <span className="font-semibold">プレビュー</span>
                  </div>
                  <iframe
                    srcDoc={generatedHTML}
                    className="w-full h-[600px]"
                    title="Preview"
                  />
                </div>
              </div>
            )}
          </div>
        </div>
      );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<ProposalGenerator />);
  </script>
</body>
</html>
